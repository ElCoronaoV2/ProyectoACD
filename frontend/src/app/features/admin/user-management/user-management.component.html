<div class="management-container">
    <h2>Gesti√≥n de Usuarios y Monitorizaci√≥n</h2>

    <!-- Stats Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <h3>Online (Con Sesi√≥n)</h3>
            <p class="stat-value text-green">{{ stats.usersOnline }}</p>
        </div>
        <div class="stat-card">
            <h3>Online (Sin Sesi√≥n)</h3>
            <p class="stat-value text-blue">{{ stats.guestsOnline }}</p>
        </div>
        <div class="stat-card">
            <h3>Total Usuarios</h3>
            <p class="stat-value">{{ stats.totalUsers }}</p>
        </div>
        <div class="stat-card">
            <h3>Sin Verificar</h3>
            <p class="stat-value text-orange">{{ stats.unverifiedUsers }}</p>
        </div>
    </div>

    <!-- Actions & Filter -->
    <div class="actions-bar">
        <div class="filters">
            <button [class.active]="selectedRole === ''" (click)="filterByRole('')">Todos</button>
            <button [class.active]="selectedRole === 'DIRECTOR'" (click)="filterByRole('DIRECTOR')">Directores</button>
            <button [class.active]="selectedRole === 'CEO'" (click)="filterByRole('CEO')">CEOs</button>
            <button [class.active]="selectedRole === 'EMPLEADO'" (click)="filterByRole('EMPLEADO')">Empleados</button>
            <button [class.active]="selectedRole === 'USER'" (click)="filterByRole('USER')">Clientes</button>
        </div>
        <button class="btn-create" (click)="openCreateModal()">+ Crear Usuario</button>
    </div>

    <!-- Users Table -->
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Email</th>
                    <th>Rol</th>
                    <th>Tel√©fono</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let user of filteredUsers">
                    <td>{{ user.nombre }}</td>
                    <td>{{ user.email }}</td>
                    <td><span class="badge" [ngClass]="getRoleBadgeClass(user.rol)">{{ user.rol }}</span></td>
                    <td>{{ user.telefono }}</td>
                    <td>
                        <span *ngIf="user.enabled" class="status-dot green" title="Verificado"></span>
                        <span *ngIf="!user.enabled" class="status-dot gray" title="No Verificado"></span>
                    </td>
                    <td>
                        <button class="btn-icon edit" (click)="openEditModal(user)" title="Editar">‚úèÔ∏è</button>
                        <button class="btn-icon delete" (click)="deleteUser(user.id)" title="Eliminar">üóëÔ∏è</button>
                    </td>
                </tr>
            </tbody>
        </table>
        <div *ngIf="loading" class="loading">Cargando usuarios...</div>
    </div>
</div>

<!-- Create User Modal -->
<div class="modal" *ngIf="showCreateModal">
    <div class="modal-content">
        <h3>Crear Nuevo Usuario</h3>
        <form (ngSubmit)="createUser()">
            <div class="form-group">
                <label>Nombre</label>
                <input type="text" [(ngModel)]="newUser.nombre" name="nombre" required>
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" [(ngModel)]="newUser.email" name="email" required>
            </div>
            <div class="form-group">
                <label>Contrase√±a</label>
                <input type="password" [(ngModel)]="newUser.password" name="password" required>
            </div>
            <div class="form-group">
                <label>Tel√©fono</label>
                <input type="text" [(ngModel)]="newUser.telefono" name="telefono">
            </div>
            <div class="form-group">
                <label>Rol</label>
                <select [(ngModel)]="newUser.rol" name="rol">
                    <option value="USER">Cliente</option>
                    <option value="EMPLEADO">Empleado</option>
                    <option value="CEO">CEO</option>
                </select>
            </div>

            <!-- Selector de Restaurante para EMPLEADO -->
            <div class="form-group" *ngIf="newUser.rol === 'EMPLEADO'">
                <label>Asignar Restaurante de Trabajo</label>
                <select [(ngModel)]="newUser.restauranteId" name="restauranteId" required>
                    <option [ngValue]="null" disabled>Selecciona un restaurante...</option>
                    <option *ngFor="let local of locales" [ngValue]="local.id">
                        {{ local.nombre }} ({{ local.ciudad }})
                    </option>
                </select>
            </div>

            <!-- Selector de Restaurantes para CEO -->
            <div class="form-group" *ngIf="newUser.rol === 'CEO'">
                <label>Asignar Restaurantes Propios</label>
                <select [(ngModel)]="newUser.restauranteIds" name="restauranteIds" multiple required
                    style="height: 100px;">
                    <option *ngFor="let local of locales" [ngValue]="local.id">
                        {{ local.nombre }} ({{ local.ciudad }})
                    </option>
                </select>
                <small class="text-hint">Manten pulsado Ctrl para seleccionar varios</small>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn-cancel" (click)="closeCreateModal()">Cancelar</button>
                <button type="submit" class="btn-submit">Crear</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal" *ngIf="showEditModal">
    <div class="modal-content">
        <h3>Editar Usuario</h3>
        <form (ngSubmit)="saveEditUser()">
            <div class="form-group">
                <label>Nombre</label>
                <input type="text" [(ngModel)]="editUserData.nombre" name="editNombre" required>
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" [(ngModel)]="editUserData.email" name="editEmail" required>
            </div>
            <div class="form-group">
                <label>Tel√©fono</label>
                <input type="text" [(ngModel)]="editUserData.telefono" name="editTelefono">
            </div>
            <div class="form-group">
                <label>Rol</label>
                <select [(ngModel)]="editUserData.rol" name="editRol">
                    <option value="USER">Cliente</option>
                    <option value="EMPLEADO">Empleado</option>
                    <option value="CEO">CEO</option>
                </select>
            </div>

            <!-- Selector de Restaurante para EMPLEADO -->
            <div class="form-group" *ngIf="editUserData.rol === 'EMPLEADO'">
                <label>Restaurante de Trabajo</label>
                <select [(ngModel)]="editUserData.restauranteTrabajoId" name="editRestauranteId">
                    <option [ngValue]="null" disabled>Selecciona un restaurante...</option>
                    <option *ngFor="let local of locales" [ngValue]="local.id">
                        {{ local.nombre }} ({{ local.direccion }})
                    </option>
                </select>
            </div>

            <!-- Selector de Restaurantes para CEO -->
            <div class="form-group" *ngIf="editUserData.rol === 'CEO'">
                <label>Restaurantes Propios</label>
                <select [(ngModel)]="editUserData.restauranteIds" name="editRestauranteIds" multiple
                    style="height: 100px;">
                    <option *ngFor="let local of locales" [ngValue]="local.id">
                        {{ local.nombre }} ({{ local.direccion }})
                    </option>
                </select>
                <small class="text-hint">Mant√©n pulsado Ctrl para seleccionar varios</small>
            </div>

            <div class="form-group">
                <label>Al√©rgenos</label>
                <input type="text" [(ngModel)]="editUserData.alergenos" name="editAlergenos"
                    placeholder="gluten, lactosa, frutos secos...">
            </div>
            <div class="form-group checkbox-group">
                <label>
                    <input type="checkbox" [(ngModel)]="editUserData.enabled" name="editEnabled">
                    Cuenta verificada
                </label>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn-cancel" (click)="closeEditModal()">Cancelar</button>
                <button type="submit" class="btn-submit">Guardar Cambios</button>
            </div>
        </form>
    </div>
</div>