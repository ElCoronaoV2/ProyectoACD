<div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="wizard-container w-full max-w-4xl bg-white rounded-xl shadow-2xl flex flex-col max-h-[90vh]">

        <!-- Header -->
        <div class="wizard-header p-6 border-b flex justify-between items-center bg-gray-50 rounded-t-xl">
            <h2 class="text-xl font-bold text-gray-800">Crear Nuevo Men√∫</h2>
            <div class="step-indicator flex gap-2">
                <div class="step-dot" [class.completed]="currentStep > 1" [class.active]="currentStep === 1">1</div>
                <div class="step-dot" [class.completed]="currentStep > 2" [class.active]="currentStep === 2">2</div>
                <div class="step-dot" [class.completed]="currentStep > 3" [class.active]="currentStep === 3">3</div>
                <div class="step-dot" [class.completed]="currentStep > 4" [class.active]="currentStep === 4">4</div>
            </div>
            <button (click)="onClose.emit()" class="text-gray-500 hover:text-gray-700">‚úï</button>
        </div>

        <!-- Body -->
        <div class="wizard-body p-8 overflow-y-auto flex-1" [formGroup]="menuForm">

            <!-- Step 1: Info B√°sica -->
            <div *ngIf="currentStep === 1" class="form-section space-y-4">
                <h3 class="text-lg font-semibold mb-4 text-gray-700">Informaci√≥n General</h3>
                <div class="input-group">
                    <label class="input-label">Nombre del Men√∫</label>
                    <input formControlName="nombre" type="text" class="input-field" placeholder="Ej: Men√∫ del D√≠a"
                        required>
                </div>
                <div class="input-group">
                    <label class="input-label">Descripci√≥n</label>
                    <textarea formControlName="descripcion" rows="3" class="input-field"
                        placeholder="Breve descripci√≥n..."></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="input-group">
                        <label class="input-label">Precio (‚Ç¨)</label>
                        <input formControlName="precio" type="number" step="0.01" class="input-field">
                    </div>
                </div>
            </div>

            <!-- Step 2: Platos -->
            <div *ngIf="currentStep === 2" class="form-section space-y-6">
                <h3 class="text-lg font-semibold mb-4 text-gray-700">Composici√≥n del Men√∫</h3>

                <!-- Primer Plato -->
                <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                    <h4 class="font-bold text-blue-800 mb-2">Primer Plato</h4>
                    <input formControlName="primerPlato" class="input-field mb-2" placeholder="Nombre del plato">
                    <input formControlName="primerPlatoDesc" class="input-field mb-2" placeholder="Descripci√≥n corta">
                    <input formControlName="primerPlatoIngredientes" class="input-field"
                        placeholder="Ingredientes principales (sep. por comas)">
                </div>

                <!-- Segundo Plato -->
                <div class="bg-green-50 p-4 rounded-lg border border-green-100">
                    <h4 class="font-bold text-green-800 mb-2">Segundo Plato</h4>
                    <input formControlName="segundoPlato" class="input-field mb-2" placeholder="Nombre del plato">
                    <input formControlName="segundoPlatoDesc" class="input-field mb-2" placeholder="Descripci√≥n corta">
                    <input formControlName="segundoPlatoIngredientes" class="input-field"
                        placeholder="Ingredientes principales">
                </div>

                <!-- Postre -->
                <div class="bg-purple-50 p-4 rounded-lg border border-purple-100">
                    <h4 class="font-bold text-purple-800 mb-2">Postre</h4>
                    <input formControlName="postre" class="input-field mb-2" placeholder="Nombre del postre">
                    <input formControlName="postreDesc" class="input-field mb-2" placeholder="Descripci√≥n corta">
                    <input formControlName="postreIngredientes" class="input-field"
                        placeholder="Ingredientes principales">
                </div>
            </div>

            <!-- Step 3: Al√©rgenos -->
            <div *ngIf="currentStep === 3" class="form-section">
                <h3 class="text-lg font-semibold mb-4 text-gray-700">Selecci√≥n de Al√©rgenos</h3>

                <!-- AI Banner -->
                <div
                    class="bg-gradient-to-r from-purple-500 to-indigo-600 rounded-lg p-6 mb-6 text-white text-center shadow-lg">
                    <div class="mb-2 text-2xl">‚ú®</div>
                    <h4 class="text-xl font-bold mb-2">Asistente de IA para Al√©rgenos</h4>
                    <p class="mb-4 text-purple-100 text-sm">Nuestra IA puede analizar los ingredientes de tus platos y
                        detectar autom√°ticamente los al√©rgenos potenciales.</p>

                    <!-- Initial Button -->
                    <button *ngIf="!analyzing" type="button" (click)="triggerAiAnalysis()"
                        class="bg-white text-purple-600 font-bold py-2 px-6 rounded-full shadow hover:bg-gray-100 transition flex items-center justify-center mx-auto gap-2">
                        <span>üöÄ</span> Analizar Men√∫ con IA
                    </button>

                    <!-- Progress Bar Section -->
                    <div *ngIf="analyzing" class="w-full max-w-md mx-auto">
                        <div class="flex justify-between items-center mb-1 text-sm font-medium text-white/90">
                            <span>{{ progressMessage }}</span>
                            <span>{{ progress }}%</span>
                        </div>
                        <div class="w-full bg-black/20 rounded-full h-2.5 backdrop-blur-sm">
                            <div class="bg-white h-2.5 rounded-full transition-all duration-300 ease-out"
                                [style.width]="progress + '%'"></div>
                        </div>
                    </div>

                    <p *ngIf="aiAnalyzed && !analyzing"
                        class="mt-3 text-sm bg-white/20 inline-block px-3 py-1 rounded animate-fade-in">
                        ‚úÖ An√°lisis completado. Por favor, verifica los resultados abajo.
                    </p>
                </div>

                <p class="text-sm text-gray-500 mb-4">Selecciona o corrige los al√©rgenos presentes en este men√∫:</p>
                <div class="allergen-grid">
                    <div *ngFor="let allergen of availableAllergens"
                        class="allergen-item flex flex-col items-center gap-1"
                        [class.selected]="isAllergenSelected(allergen.name)" (click)="toggleAllergen(allergen.name)">
                        <span class="text-2xl">{{ allergen.icon }}</span>
                        <span class="text-sm font-medium">{{ allergen.name }}</span>
                    </div>
                </div>
            </div>

            <!-- Step 4: Preview -->
            <div *ngIf="currentStep === 4" class="form-section">
                <div class="menu-preview max-w-2xl mx-auto shadow-lg p-8 bg-white border">
                    <h2 class="preview-title text-3xl text-center font-serif mb-6 border-b pb-4">{{
                        menuForm.get('nombre')?.value }}</h2>
                    <p class="text-center text-gray-500 italic mb-6">{{ menuForm.get('descripcion')?.value }}</p>

                    <div class="preview-course mb-6">
                        <div class="course-title text-xs font-bold uppercase text-gray-400 tracking-wider">De Primero
                        </div>
                        <div class="course-name text-xl font-medium text-gray-800">{{ menuForm.get('primerPlato')?.value
                            }}</div>
                        <div class="course-desc text-gray-500">{{ menuForm.get('primerPlatoDesc')?.value }}</div>
                    </div>

                    <div class="preview-course mb-6">
                        <div class="course-title text-xs font-bold uppercase text-gray-400 tracking-wider">De Segundo
                        </div>
                        <div class="course-name text-xl font-medium text-gray-800">{{
                            menuForm.get('segundoPlato')?.value }}</div>
                        <div class="course-desc text-gray-500">{{ menuForm.get('segundoPlatoDesc')?.value }}</div>
                    </div>

                    <div class="preview-course mb-6">
                        <div class="course-title text-xs font-bold uppercase text-gray-400 tracking-wider">Postre</div>
                        <div class="course-name text-xl font-medium text-gray-800">{{ menuForm.get('postre')?.value }}
                        </div>
                        <div class="course-desc text-gray-500">{{ menuForm.get('postreDesc')?.value }}</div>
                    </div>

                    <div class="mt-8 pt-6 border-t flex justify-between items-end">
                        <div class="text-sm text-red-500 max-w-[60%]">
                            <strong>Al√©rgenos:</strong> {{ menuForm.get('alergenos')?.value.join(', ') || 'Ninguno' }}
                        </div>
                        <div class="text-2xl font-bold text-gray-900">{{ menuForm.get('precio')?.value }}‚Ç¨</div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Footer -->
        <div class="wizard-footer p-6 border-t bg-gray-50 rounded-b-xl flex justify-between">
            <button type="button" class="btn btn-secondary" (click)="currentStep === 1 ? onClose.emit() : prevStep()">
                {{ currentStep === 1 ? 'Cancelar' : 'Atr√°s' }}
            </button>
            <button type="button" class="btn" [class.btn-primary]="currentStep < 4"
                [class.btn-success]="currentStep === 4" (click)="currentStep === 4 ? submit() : nextStep()"
                [disabled]="loading || (currentStep === 1 && menuForm.get('nombre')?.invalid) || (currentStep === 1 && menuForm.get('precio')?.invalid)">
                {{ currentStep === 4 ? (loading ? 'Guardando...' : 'Confirmar y Guardar') : 'Siguiente' }}
            </button>
        </div>
    </div>
</div>